# ==============================================================================
# Laravel Docker Development Environment - 2025 Edition
# Versões: PHP 8.4, MySQL 9.1/8.4 LTS, PostgreSQL 17, Redis 8, Traefik 3.6
# Suporta: SSL, domínios personalizados, wildcards para subdomínios
# Inclui: MySQL, PostgreSQL, Redis, MinIO (S3), Mailpit, Xdebug
# ==============================================================================

networks:
  laravel-dev:
    name: laravel-dev
    driver: bridge

services:
  # ============================================================================
  # TRAEFIK 3.6 - Reverse Proxy com SSL e roteamento dinâmico
  # ============================================================================
  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=laravel-dev"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Dashboard Traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./certs:/etc/certs:ro
    networks:
      - laravel-dev
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.service=api@internal"

  # ============================================================================
  # PHP-FPM 8.4 com Xdebug e todas as extensões Laravel
  # ============================================================================
  php:
    build:
      context: ./php
      dockerfile: Dockerfile
      args:
        - XDEBUG_ENABLED=${XDEBUG_ENABLED:-true}
        - UID=${DOCKER_UID:-1000}
        - GID=${DOCKER_GID:-1000}
    container_name: php
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - ${PROJECTS_PATH:-../projects}:/var/www:cached
      - ./php/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - ./php/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini:ro
    networks:
      - laravel-dev
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - PHP_MEMORY_LIMIT=512M
      - COMPOSER_MEMORY_LIMIT=-1
      - XDEBUG_MODE=${XDEBUG_MODE:-develop,debug}
      - XDEBUG_CONFIG=client_host=host.docker.internal
    depends_on:
      mysql:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ============================================================================
  # NGINX - Servidor Web (Alpine latest)
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    volumes:
      - ${PROJECTS_PATH:-../projects}:/var/www:cached
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - laravel-dev
    depends_on:
      php:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      # Rota principal para *.localhost
      - "traefik.http.routers.nginx.rule=HostRegexp(`{subdomain:[a-z0-9-]+}.localhost`)"
      - "traefik.http.routers.nginx.entrypoints=websecure"
      - "traefik.http.routers.nginx.tls=true"
      - "traefik.http.routers.nginx.priority=1"
      # Rota para *.test (domínio customizado)
      - "traefik.http.routers.nginx-test.rule=HostRegexp(`{subdomain:[a-z0-9-]+}.test`)"
      - "traefik.http.routers.nginx-test.entrypoints=websecure"
      - "traefik.http.routers.nginx-test.tls=true"
      - "traefik.http.routers.nginx-test.priority=1"
      # Rota para subdomínios: *.projeto.test
      - "traefik.http.routers.nginx-subdomains.rule=HostRegexp(`{sub:[a-z0-9-]+}.{project:[a-z0-9-]+}.test`)"
      - "traefik.http.routers.nginx-subdomains.entrypoints=websecure"
      - "traefik.http.routers.nginx-subdomains.tls=true"
      - "traefik.http.routers.nginx-subdomains.priority=2"
      # Service
      - "traefik.http.services.nginx.loadbalancer.server.port=80"

  # ============================================================================
  # MySQL 9.1 (Innovation) - Versão mais recente
  # Para LTS estável, troque para mysql:8.4-lts
  # ============================================================================
  mysql:
    image: mysql:${MYSQL_VERSION:-9.1}
    container_name: mysql
    restart: unless-stopped
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-secret}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-laravel}
      MYSQL_USER: ${MYSQL_USER:-laravel}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-secret}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d:ro
      - ./mysql/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
    networks:
      - laravel-dev
    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-secret}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================================================
  # PostgreSQL 17 com pgvector - Suporte a embeddings vetoriais para IA
  # Compatível com PostgreSQL padrão, adiciona extensão pgvector
  # ============================================================================
  postgres:
    image: pgvector/pgvector:pg17
    container_name: postgres
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DATABASE:-laravel}
      POSTGRES_USER: ${POSTGRES_USER:-laravel}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secret}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    networks:
      - laravel-dev
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-laravel} -d ${POSTGRES_DATABASE:-laravel}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================================================
  # Redis 8 - Versão mais recente
  # ============================================================================
  redis:
    image: redis:8-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - laravel-dev
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Mailpit - Email Testing (latest)
  # ============================================================================
  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    restart: unless-stopped
    ports:
      - "${MAILPIT_WEB_PORT:-8025}:8025"  # Web UI
      - "${MAILPIT_SMTP_PORT:-1025}:1025"  # SMTP
    environment:
      MP_MAX_MESSAGES: 5000
      MP_DATABASE: /data/mailpit.db
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    volumes:
      - mailpit_data:/data
    networks:
      - laravel-dev
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mailpit.rule=Host(`mail.localhost`)"
      - "traefik.http.routers.mailpit.entrypoints=websecure"
      - "traefik.http.routers.mailpit.tls=true"
      - "traefik.http.services.mailpit.loadbalancer.server.port=8025"

  # ============================================================================
  # MinIO - S3-Compatible Storage (latest)
  # ============================================================================
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
    volumes:
      - minio_data:/data
    networks:
      - laravel-dev
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      # Console MinIO
      - "traefik.http.routers.minio-console.rule=Host(`minio.localhost`)"
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.tls=true"
      - "traefik.http.routers.minio-console.service=minio-console"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"
      # API MinIO (para S3)
      - "traefik.http.routers.minio-api.rule=Host(`s3.localhost`)"
      - "traefik.http.routers.minio-api.entrypoints=websecure"
      - "traefik.http.routers.minio-api.tls=true"
      - "traefik.http.routers.minio-api.service=minio-api"
      - "traefik.http.services.minio-api.loadbalancer.server.port=9000"

  # ============================================================================
  # MinIO Client - Cria bucket automaticamente
  # ============================================================================
  minio-setup:
    image: minio/mc:latest
    container_name: minio-setup
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - laravel-dev
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio http://minio:9000 ${MINIO_ROOT_USER:-minio} ${MINIO_ROOT_PASSWORD:-minio123};
      mc mb myminio/${MINIO_BUCKET:-laravel} --ignore-existing;
      mc anonymous set public myminio/${MINIO_BUCKET:-laravel}/public;
      echo 'MinIO bucket criado com sucesso!';
      exit 0;
      "

  # ============================================================================
  # PHP-AI - PHP com Whisper/FFmpeg para IA
  # Inclui OpenAI Whisper para transcrição de áudio
  # Imagem maior (~3GB) mas com ferramentas de IA
  # ============================================================================
  php-ai:
    build:
      context: ./php-ai
      dockerfile: Dockerfile
      args:
        - XDEBUG_ENABLED=${XDEBUG_ENABLED:-false}
        - UID=${DOCKER_UID:-1000}
        - GID=${DOCKER_GID:-1000}
        - WHISPER_MODEL=${WHISPER_MODEL:-base}
    container_name: php-ai
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - ${PROJECTS_PATH:-../projects}:/var/www:cached
    networks:
      - laravel-dev
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - PHP_MEMORY_LIMIT=1G
      - COMPOSER_MEMORY_LIMIT=-1
      - WHISPER_MODEL=${WHISPER_MODEL:-base}
      - WHISPER_LANGUAGE=${WHISPER_LANGUAGE:-en}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ============================================================================
  # RTMP Server - Live Streaming
  # Ingest: rtmp://localhost:1935/live/<stream_key>
  # HLS: http://localhost:8088/hls/<stream_key>.m3u8
  # ============================================================================
  rtmp:
    image: tiangolo/nginx-rtmp:latest
    container_name: rtmp
    restart: unless-stopped
    ports:
      - "${RTMP_PORT:-1935}:1935"      # RTMP ingest
      - "${RTMP_HLS_PORT:-8088}:80"    # HLS delivery
    volumes:
      - ./rtmp/nginx-rtmp.conf:/etc/nginx/nginx.conf:ro
      - rtmp_hls:/var/www/hls
      - rtmp_recordings:/var/www/recordings
    networks:
      - laravel-dev
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rtmp-hls.rule=Host(`stream.localhost`)"
      - "traefik.http.routers.rtmp-hls.entrypoints=websecure"
      - "traefik.http.routers.rtmp-hls.tls=true"
      - "traefik.http.services.rtmp-hls.loadbalancer.server.port=80"

  # ============================================================================
  # Node.js - Asset Compilation
  # Para builds de frontend com Vite, Webpack, etc.
  # ============================================================================
  node:
    image: node:20-alpine
    container_name: node
    working_dir: /var/www
    volumes:
      - ${PROJECTS_PATH:-../projects}:/var/www:cached
    networks:
      - laravel-dev
    tty: true
    stdin_open: true
    command: ["sh", "-c", "echo 'Node.js container ready' && tail -f /dev/null"]

  # ============================================================================
  # Whisper ASR - Speech-to-Text API (OpenAI-compatible)
  # Uses faster-whisper-server for OpenAI-compatible /v1/audio/transcriptions
  # API: http://whisper:8000/v1/audio/transcriptions
  # Docs: http://localhost:9501/docs
  # ============================================================================
  whisper:
    image: fedirz/faster-whisper-server:latest-cpu
    container_name: whisper
    restart: unless-stopped
    ports:
      - "${WHISPER_PORT:-9501}:8000"
    environment:
      WHISPER__MODEL: ${WHISPER_MODEL:-Systran/faster-whisper-base}
      WHISPER__INFERENCE_DEVICE: cpu
    volumes:
      - whisper_cache:/root/.cache/huggingface
    networks:
      - laravel-dev
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whisper.rule=Host(`whisper.localhost`)"
      - "traefik.http.routers.whisper.entrypoints=websecure"
      - "traefik.http.routers.whisper.tls=true"
      - "traefik.http.services.whisper.loadbalancer.server.port=8000"

volumes:
  mysql_data:
    name: laravel-dev-mysql
  postgres_data:
    name: laravel-dev-postgres
  redis_data:
    name: laravel-dev-redis
  minio_data:
    name: laravel-dev-minio
  mailpit_data:
    name: laravel-dev-mailpit
  rtmp_hls:
    name: laravel-dev-rtmp-hls
  rtmp_recordings:
    name: laravel-dev-rtmp-recordings
  whisper_cache:
    name: laravel-dev-whisper-cache
